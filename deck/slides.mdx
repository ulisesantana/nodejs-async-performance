import {Steps, Footer, Notes} from 'mdx-deck'
import {
  Code,
  ProfileImage,
  LeanMind,
  Row,
  GlobalStyle,
  FluidContainer,
  Footer as SlideFooter
} from "./components";
import {isPortrait} from "./helpers"

import nodeJsLogo from "./assets/images/node-js-logo.svg"
import lumberjackImage from "./assets/images/lumberjack.jpeg"
import ulises from "./assets/images/ulises.jpeg"
import matteo from "./assets/images/matteo.jpg"
import james from "./assets/images/james.jpg"
import mocha from "./assets/images/mocha-puppy.jpg"
import nullTheCat from "./assets/images/null.jpg"
import mochaAndNull from "./assets/images/mocha-and-null.jpg"
import cjsToESM from "./assets/images/cjs-to-esm.png"

import coffinDance from "./assets/gifs/coffin-dance.gif"
import sheldonBag from "./assets/gifs/sheldon-bag.gif"
import pickleRick from "./assets/gifs/pickle-rick.gif"
import dude from "./assets/gifs/fuck-yeah-dude.gif"

import uselessAsync from "./assets/screenshots/useless-async.png"
import asyncLoop from "./assets/screenshots/async-loop.png"
import cachedPromises from "./assets/screenshots/cached-promises.png"

export const theme = {
  styles: GlobalStyle
}

<Footer>
  <SlideFooter/>
</Footer>

## Cómo pasé un proceso en

<img
  src={nodeJsLogo}
  style={{height: '30vmin'}}
  alt="Node.js logo"
/>

## de 5 horas a 5 minutos
---

<FluidContainer style={{
  alignContent: 'center',
  justifyContent: isPortrait() ? 'center' : 'space-around' ,
  textAlign: isPortrait() ? 'center' : 'right',
  width: '100%'
}}>

  <div style={{
    alignItems: isPortrait() ? 'center' : 'start',
    display: 'flex',
    flexDirection: 'column',
    justifyContent: 'center'
  }}>

  # Ulises Santana

  Full Stack Developer en

  <LeanMind size="250px"/>

  </div>

  <div style={{
    alignItems: 'center',
    display: 'flex',
    flexDirection: 'column',
    justifyContent: 'center'
  }}>

  <ProfileImage
    src={ulises}
    size="50vmin"
    alt="Foto de Ulises Santana"
  />

  # ulisesantana.dev

  </div>

</FluidContainer>

---

<Row alignCenter>
  <img
    src={mocha}
    alt="Mi perra Mocha"
    style={{height: '40vmin', transform: 'rotate(-15deg)'}}
  />
  <img
    src={nullTheCat}
    alt="Mi gato Null"
    style={{height: '40vmin', transform: 'rotate(15deg)'}}
  />
</Row>

<img
  src={mochaAndNull}
  alt="Mocha y Null siendo felices"
  style={{height: '40vmin'}}
/>

---

# Contexto

<Steps>

1. No todo el equipo controlaba la tecnología en la que se estaba trabajando.
1. El deadline es fijo y crítico, ya que rompemos el cash flow de la empresa en caso de retrasarnos.

</Steps>

---

# *Dame 6 horas para cortar un árbol y pasaré 4 afilando el hacha*

---

## El Proyecto Leñador

<img
  src={lumberjackImage}
  alt="Ulises vestido de leñador con hacha en mano"
  style={{height: '50vmin'}}
/>

---

## Prototipo original:

~7 minutos

<Steps>
  <div>
    <h2>Proyecto Leñador:</h2>
    <p
      style={{
        color: 'red',
        fontWeight: 'bold',
        textDecoration: "underline"
      }}
    >
      5 horas 7 minutos y 54 segundos
    </p>
  </div>
</Steps>

---

<h1
  style={{
    fontSize: '20vw',
    color: 'red'
  }}
>
  + 4400%
</h1>

---
<img
  src={coffinDance}
  alt="Gif de los bailarines del ataúd (Coffin dance)"
  style={{
    width: '80vw'
  }}
/>


---

# Deadline: 10 días

<Steps>
  <h1 style={{textDecoration: 'underline'}}>NATURALES</h1>
</Steps>


---

<FluidContainer>
  <div>
    <ProfileImage
      src={matteo}
      alt="Foto de Matteo Collina"
      size="60vmin"
    />

  ## @matteocollina

  </div>

  <div>
    <ProfileImage
      src={james}
      alt="Foto de James Snell"
      size="60vmin"
    />

  ## @jasnell

  </div>
</FluidContainer>

---

<FluidContainer>
  <img
    src={sheldonBag}
    alt="Gif de Sheldon respirando en una bolsa de papel"
    style={{
      width: '45vw'
    }}
  />
  <img
    src={pickleRick}
    alt="Gif de Pickle Rick agonizando bajo el sol"
    style={{
      width: '35vw'
    }}
  />
</FluidContainer>

---

# 1. Evita async innecesarios

---

<Code>

  ```js
  export function randomNumber() {
      return Math.random()
  }

  export async function asyncRandomNumber() {
      return Math.random()
  }
  ```

  ```diff 5[7:13]
  ```

</Code>

<Notes>

- Ten en cuenta que cada función asíncrona de por sí devuelve una promesa.
- Si devuelves una promesa JavaScript tiene que gestionarlo.
- En una suite de test (bastante grande) reducimos un 40% el tiempo que tardaba en ejecutarse sólo quitando los async innecesarios

</Notes>

---

<img
  src={uselessAsync}
  alt="Resultado demo useless-async"
/>

---

<Code>

```js
describe('This feature should', () => {
  it('do stuff', async () => {
    //test...
  })

  it('do more stuff', async () => {
    //test...
  })
})
```

```diff 2[18:23],6[23:28]
```

</Code>

---

# 2. Evita los await dentro de los bucles

---

<Code>

  ```js
  async function fetchUserListInfo(ids) {
    const values = []
    for (const id of ids) {
      values.push(await fetchUserInfo(id))
    }
    return values
  }
  ```

  ```js 1:7
  function fetchUserListInfo(ids) {
    const values = []
    for (const id of ids) {
      values.push(fetchUserInfo(id))
    }
    return Promise.all(values)
  }
  ```

  ```diff 1
  ```

  ```diff 4
  ```

  ```diff 6
  ```

</Code>

---

<img
  src={asyncLoop}
  alt="Resultado demo async-loop"
/>

---

# 3. Usa Promise.all siempre que puedas

---

<Code>

  ```js
  async function readAllUserInfo(userId) {
    const user = await readUser(userId)
    const contracts = await readContractsForUser(userId)
    const invoices = await readInvoicesForUser(userId)
    return {
      ...user,
      contracts,
      invoices
    }
  }
  ```

  ```js
  async function readAllUserInfo(userId) {
    const [ user, contracts, invoices ] = await Promise.all([
      readUser(userId),
      readContractsForUser(userId),
      readInvoicesForUser(userId)
    ])
    return {
      ...user,
      contracts,
      invoices
    }
  }
  ```

</Code>

---

# 4. Sé consciente de cuantas promesas estás gestionando

---

<Code>

```js
function fetchUserListInfo(ids) {
  return Promise.all(ids.map(fetchUserInfo))
}
```

```js
import pMap from 'p-map';

function fetchUserListInfo(ids) {
  return pMap(
    ids,
    fetchUserInfo,
    {concurrency: 10}
  )
}
```

</Code>

---

<img
  src={cjsToESM}
  alt="De CommonJS a ES Modules"
/>

---

# 5. Cachear queries

---

<Code>

```js
function CacheByValue() {
  let value = undefined

  return {
    async getNumber() {
      if (value === undefined) {
        value = await doSomethingAsync()
      }
      return value
    }
  }
}
```

```js
function CacheByPromise() {
  let value = undefined

  return {
    getNumber() {
      if (value === undefined) {
        value = doSomethingAsync()
      }
      return value
    }
  }
}
```

</Code>

---

<img
  src={cachedPromises}
  alt="Resultado demo cached-promises"
/>

---

# 6. Haz caso de los warnings

---

<Code>

  ```shell
  (node) warning: possible EventEmitter memory leak detected.
  11 listeners added.
  Use emitter.setMaxListeners() to increase limit.
  ```

</Code>

---

## Prototipo original:

~7 minutos

<Steps>
  <div>
    <h2>Proyecto Leñador:</h2>
    <p
      style={{
        color: 'green',
        fontWeight: 'bold'
      }}
    >
      4 minutos y 52 segundos
    </p>
  </div>
</Steps>

---

<img
  src={dude}
  alt="La vida puede ser maravillosa cuando todo funciona"
  style={{
    width: '60vw'
  }}
/>

---

## Prototipo original:

41 minutos y 29 segundos

<Steps>
  <div>
    <h2>Proyecto Leñador:</h2>
    <p
      style={{
        color: 'green',
        fontWeight: 'bold'
      }}
    >
      31 minutos y 56 segundos
    </p>
  </div>
</Steps>

---

<h1
  style={{
    fontSize: '20vw',
    color: 'green'
  }}
>
  - 20%
</h1>

---

# Aprendizaje

<Steps>

  1. La asincronía en JS está más incomprendida de lo que pensaba
  1. Forma a tu equipo
  1. No necesitas un ejército de Seniors aka personas experimentadas en X tecnología
  1. Sé prescindible

</Steps>

---

# Conclusión

<Steps>

  1. Evita los async innecesarios
  1. Evita los await dentro de los bucles
  1. Usa Promise.all siempre que puedas
  1. Sé consciente de cuantas promesas estás gestionando
  1. Cachea la promesa en vez del valor que resuelve
  1. No ignores los warnings

</Steps>

---

# ¡Gracias!
